<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family:'Sarabun'; margin:28px; background:#fbf8ee; color:#333; }
    h2 { font-family:'Prompt'; text-align:center; color:#4a897e; font-size:30px; }
    .quote { text-align:center; color:#666; margin-bottom:12px; font-size:13px; }
    canvas { max-width:100%; display:block; margin: 18px auto; }
    .summary { max-width:900px; margin: 16px auto; padding:14px; background:#f9f9f9; border-radius:12px; }
    ul{ padding-left:0; list-style:none; color:#345; }
    li{ margin:6px 0; }
  </style>
</head>
<body>
  <div class="quote">"1 ‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢ 450 ‡∏õ‡∏µ ‚Äî ‡πÅ‡∏ï‡πà 1 ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ó‡∏¥‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ"</div>
  <h2>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
  <canvas id="scoreChart" height="160"></canvas>

  <div class="summary" id="summaryBox"></div>

<script>
  const wasteKeyMap = {
  A: "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å",
  B: "‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
  C: "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
  D: "‡∏Ç‡∏¢‡∏∞‡∏ñ‡∏±‡∏á‡∏£‡∏ß‡∏°"
};

  const scoreMap = {
    "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å": 10,
    "‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ": 5,
    "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ": 3,
  "‡∏Ç‡∏¢‡∏∞‡∏ñ‡∏±‡∏á‡∏£‡∏ß‡∏°":0,
    "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": 1,
    "‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": -1
  };
async function loadAndRender(){
  let nameMap = {};
  try {
    const res = await fetch('students.json');
    if(res.ok){
      const data = await res.json();
      data.forEach(s => nameMap[s.id] = s.name);
    }
  } catch(e){ console.warn('students.json not loaded', e); }

  let logs = {};
  try {
    const res2 = await fetch("https://robotwaste-server-2.onrender.com/logs");
    if(res2.ok){
      logs = await res2.json();
    }
  } catch(e){
    console.error('can not load logs from server:', e);
  }

  const studentScores = [];
  const wasteTypeCounts = { "‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å":0, "‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ":0, "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ":0 ,"‡∏Ç‡∏¢‡∏∞‡∏ñ‡∏±‡∏á‡∏£‡∏ß‡∏°":0};
  let totalWasteItems = 0;

  for(const studentId in logs){
    const entries = logs[studentId];
    let total = 0;

    entries.forEach(e=>{
      const score = ( (e.A||0)*10 + (e.B||0)*5 + (e.C||0)*3 + (e.D||0)*0 );
      total += score;

      wasteTypeCounts["‡∏Ç‡∏ß‡∏î‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å"] += e.A||0;
      wasteTypeCounts["‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] += e.B||0;
      wasteTypeCounts["‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"] += e.C||0;
      wasteTypeCounts["‡∏Ç‡∏¢‡∏∞‡∏ñ‡∏±‡∏á‡∏£‡∏ß‡∏°"] += e.D||0;
      totalWasteItems += (e.A||0) + (e.B||0) + (e.C||0) + (e.D||0);
    });

    studentScores.push({ studentId, total });
  }

  studentScores.sort((a,b)=>b.total - a.total);
  const labels = studentScores.map(e => nameMap[e.studentId] || e.studentId);
  const scores = studentScores.map(e => e.total);

  const ctx = document.getElementById("scoreChart");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°',
        data: scores,
        backgroundColor: 'rgba(77,182,172,0.75)',
        borderColor: '#00796b',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${ctx.parsed.y} ‡πÅ‡∏ï‡πâ‡∏°`
          }
        }
      },
      scales: {
        y: { beginAtZero:true, title:{ display:true, text:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô' } },
        x: { title:{ display:true, text:'‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' } }
      }
    }
  });

  const summaryBox = document.getElementById("summaryBox");
  const top3 = studentScores.slice(0,3).map((e,i)=>{
    const nm = nameMap[e.studentId] || e.studentId;
    return `<li>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${i+1}: <strong>${nm}</strong> ‚Äî ${e.total} ‡πÅ‡∏ï‡πâ‡∏°</li>`;
  }).join("");

  const percentList = Object.entries(wasteTypeCounts).map(([k,v])=>{
    const perc = totalWasteItems ? ((v/totalWasteItems)*100).toFixed(1) : 0;
    return `<li>${k}: ${v} ‡∏ä‡∏¥‡πâ‡∏ô (${perc}%)</li>`;
  }).join("");

  summaryBox.innerHTML = `
    <h3>üéñÔ∏è ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1‚Äì3</h3>
    <ul>${top3}</ul>
    <h3>‚ôªÔ∏è ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏¢‡∏∞</h3>
    <ul>${percentList}</ul>
    <h3>üßæ ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏¢‡∏∞‡∏£‡∏ß‡∏°: ${totalWasteItems} ‡∏ä‡∏¥‡πâ‡∏ô</h3>
  `;
}
loadAndRender();
setInterval(loadAndRender, 3000);
  loadAndRender();
</script>

</body>
</html>
